<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Promise 全解 | 奋斗的胖锦</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Promise 全解</h1><a id="logo" href="/.">奋斗的胖锦</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Promise 全解</h1><div class="post-meta">2019-05-24<span> | </span><span class="category"><a href="/categories/JS%E5%8E%9F%E7%90%86/">JS原理</a></span></div><div class="post-content"><h3 id="什么是-Promise"><a href="#什么是-Promise" class="headerlink" title="什么是 Promise"></a>什么是 Promise</h3><h4 id="Promise-是为了解决-ES5-的回调地狱而出现的。"><a href="#Promise-是为了解决-ES5-的回调地狱而出现的。" class="headerlink" title="Promise 是为了解决 ES5 的回调地狱而出现的。"></a>Promise 是为了解决 ES5 的回调地狱而出现的。</h4><h3 id="Promise-用法与-API"><a href="#Promise-用法与-API" class="headerlink" title="Promise 用法与 API"></a>Promise 用法与 API</h3><h4 id="Promise-使用示例："><a href="#Promise-使用示例：" class="headerlink" title="Promise 使用示例："></a>Promise 使用示例：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">let kfc = new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">  console.log(&quot;肯德基厨房开始做饭&quot;);</span><br><span class="line">  resolve(&quot;我是肯德基，你的餐已经做好了&quot;);</span><br><span class="line">&#125;);</span><br><span class="line">let dad = kfc.then(msg =&gt; &#123;</span><br><span class="line">  console.log(`收到肯德基消息: $&#123;msg&#125;`);</span><br><span class="line">  return &#123;</span><br><span class="line">    then(resolve) &#123;</span><br><span class="line">      setTimeout(() =&gt; &#123;</span><br><span class="line">        resolve(&quot;孩子，我吃了两秒了，不辣，你可以吃了&quot;);</span><br><span class="line">      &#125;, 2000);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line">let son = dad.then(msg =&gt; &#123;</span><br><span class="line">  return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">    console.log(`收到爸爸消息: $&#123;msg&#125;`);</span><br><span class="line">    setTimeout(() =&gt; &#123;</span><br><span class="line">      resolve(&quot;妈妈，我和向军爸爸吃完饭了&quot;);</span><br><span class="line">    &#125;, 2000);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">let ma = son.then(msg =&gt; &#123;</span><br><span class="line">  console.log(`收到孩子消息: $&#123;msg&#125;,事情结束`);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>本示例<a target="_blank" rel="noopener" href="https://doc.houdunren.com/js/15%20Promise.html#%E8%82%AF%E5%BE%B7%E5%9F%BA">来源</a></p>
<h4 id="Promise-API："><a href="#Promise-API：" class="headerlink" title="Promise API："></a>Promise API：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Promise.all()</span><br><span class="line">Promise.allSettled()</span><br><span class="line">Promise.any()</span><br><span class="line">Promise.prototype.catch()</span><br><span class="line">Promise.prototype.finally()</span><br><span class="line">Promise.race()</span><br><span class="line">Promise.reject()</span><br><span class="line">Promise.resolve()</span><br><span class="line">Promise.prototype.then()</span><br></pre></td></tr></table></figure>

<h4 id="Promise-实现的队列"><a href="#Promise-实现的队列" class="headerlink" title="Promise 实现的队列"></a>Promise 实现的队列</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function queue(nums) &#123;</span><br><span class="line">  let promise = Promise.resolve();</span><br><span class="line">  nums.map(n =&gt; &#123;</span><br><span class="line">    promise = promise.then(v =&gt; &#123;</span><br><span class="line">      return new Promise(resolve =&gt; &#123;</span><br><span class="line">        console.log(n);</span><br><span class="line">        resolve();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">function queue(nums) &#123;</span><br><span class="line">  return nums.reduce((promise, n) =&gt; &#123;</span><br><span class="line">    return promise.then(() =&gt; &#123;</span><br><span class="line">      return new Promise(resolve =&gt; &#123;</span><br><span class="line">        console.log(n);</span><br><span class="line">        resolve();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, Promise.resolve());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><h4 id="实现源码，首先可以确定的是-Promise-是一个可以-new-的构造函数。另外可以从参数、返回值来思考。首先-Promise-接收一个函数，函数有两个参数，分别是成功的回调与失败的回调。然后返回值是一个新的-Promise。而且-Promise-是支持链式调用的，所以-then，catch，finally-都返回一个新的-Promise。Promise-有三个状态，从-pending-到-fulfilled-或-rejected，不可逆。并且是异步。then-的返回的-promise-不能是-then-相同的-Promise。另外-API-是构造函数直接调用的，所以要用-static。"><a href="#实现源码，首先可以确定的是-Promise-是一个可以-new-的构造函数。另外可以从参数、返回值来思考。首先-Promise-接收一个函数，函数有两个参数，分别是成功的回调与失败的回调。然后返回值是一个新的-Promise。而且-Promise-是支持链式调用的，所以-then，catch，finally-都返回一个新的-Promise。Promise-有三个状态，从-pending-到-fulfilled-或-rejected，不可逆。并且是异步。then-的返回的-promise-不能是-then-相同的-Promise。另外-API-是构造函数直接调用的，所以要用-static。" class="headerlink" title="实现源码，首先可以确定的是 Promise 是一个可以 new 的构造函数。另外可以从参数、返回值来思考。首先 Promise 接收一个函数，函数有两个参数，分别是成功的回调与失败的回调。然后返回值是一个新的 Promise。而且 Promise 是支持链式调用的，所以 then，catch，finally 都返回一个新的 Promise。Promise 有三个状态，从 pending 到 fulfilled 或 rejected，不可逆。并且是异步。then 的返回的 promise 不能是 then 相同的 Promise。另外 API 是构造函数直接调用的，所以要用 static。"></a>实现源码，首先可以确定的是 Promise 是一个可以 new 的构造函数。另外可以从参数、返回值来思考。首先 Promise 接收一个函数，函数有两个参数，分别是成功的回调与失败的回调。然后返回值是一个新的 Promise。而且 Promise 是支持链式调用的，所以 then，catch，finally 都返回一个新的 Promise。Promise 有三个状态，从 pending 到 fulfilled 或 rejected，不可逆。并且是异步。then 的返回的 promise 不能是 then 相同的 Promise。另外 API 是构造函数直接调用的，所以要用 static。</h4><!-- 因为 Promise 是链式调用的，所以 then 与 catch 方法是在 prototype 上。 -->

<h3 id="源码实现"><a href="#源码实现" class="headerlink" title="源码实现"></a>源码实现</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line">// 1. 三状态，不可逆 this指向全局，所以要绑定</span><br><span class="line">// 2. resolve 可以为空，所以要判断</span><br><span class="line">// 3. 处理executer不同参数数量的情况</span><br><span class="line">// 4. 异步</span><br><span class="line">// 5. 链式调用</span><br><span class="line">// 6. 处理 then中其他返回值，如Promise</span><br><span class="line">// 7. 返回约束</span><br><span class="line">// 8. 实现静态方法all(),allSettled(),any(),race(),reject(),resolve()</span><br><span class="line"></span><br><span class="line">class MyPromise &#123;</span><br><span class="line">    static PENDING = &quot;pending&quot;;</span><br><span class="line">    static FULFILLED = &quot;fulfilled&quot;;</span><br><span class="line">    static REJECTED = &quot;rejected&quot;;</span><br><span class="line">    constructor(executer) &#123;</span><br><span class="line">        this.state = MyPromise.PENDING;</span><br><span class="line">        this.value = null;</span><br><span class="line">        this.error = null;</span><br><span class="line">        this.callbacks = []; //存储then中传入的参数,then方法可以调用多次</span><br><span class="line">        try &#123;</span><br><span class="line">            executer(this._resolve.bind(this), this._reject.bind(this));</span><br><span class="line">        &#125; catch (e) &#123;</span><br><span class="line">            this._reject(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    static resolve(value) &#123;</span><br><span class="line">        return new MyPromise((resolve, reject) =&gt; &#123;</span><br><span class="line">            if (value instanceof MyPromise) &#123;</span><br><span class="line">                value.then(resolve, reject);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                resolve(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    static reject(reason) &#123;</span><br><span class="line">        return new MyPromise((_, reject) =&gt; &#123;</span><br><span class="line">            reject(reason);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    static any(promises) &#123;</span><br><span class="line">        let rejects = [];</span><br><span class="line">        return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">            promises.forEach((promise) =&gt; &#123;</span><br><span class="line">                promise.then(</span><br><span class="line">                    (value) =&gt; &#123;</span><br><span class="line">                        resolve(value);</span><br><span class="line">                    &#125;,</span><br><span class="line">                    (reason) =&gt; &#123;</span><br><span class="line">                        rejects.push(reason);</span><br><span class="line">                        if (rejects.length === promises.length) &#123;</span><br><span class="line">                            reject(rejects);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    static race(promises) &#123;</span><br><span class="line">        return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">            promises.map((promise) =&gt; &#123;</span><br><span class="line">                promise.then(</span><br><span class="line">                    (value) =&gt; &#123;</span><br><span class="line">                        resolve(value);</span><br><span class="line">                    &#125;,</span><br><span class="line">                    (reason) =&gt; &#123;</span><br><span class="line">                        reject(reason);</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    static all(promises) &#123;</span><br><span class="line">        let resolves = [];</span><br><span class="line">        return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">            promises.forEach((promise) =&gt; &#123;</span><br><span class="line">                promise.then(</span><br><span class="line">                    (value) =&gt; &#123;</span><br><span class="line">                        resolves.push(value);</span><br><span class="line">                        if (resolves.length === promises.length) &#123;</span><br><span class="line">                            resolve(resolves);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    (reason) =&gt; &#123;</span><br><span class="line">                        reject(reason);</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    static allSettled(promises) &#123;</span><br><span class="line">        return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">            let promiseArrays = [];</span><br><span class="line">            promises.forEach((promise, index) =&gt; &#123;</span><br><span class="line">                promise.then(</span><br><span class="line">                    (value) =&gt; &#123;</span><br><span class="line">                        promiseArrays.push(&#123;</span><br><span class="line">                            status: MyPromise.FULFILLED,</span><br><span class="line">                            value,</span><br><span class="line">                        &#125;);</span><br><span class="line">                        if (index === promises.length - 1) &#123;</span><br><span class="line">                            resolve(promiseArrays);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    (reason) =&gt; &#123;</span><br><span class="line">                        promiseArrays.push(&#123;</span><br><span class="line">                            status: MyPromise.REJECTED,</span><br><span class="line">                            reason,</span><br><span class="line">                        &#125;);</span><br><span class="line">                        if (index === promises.length - 1) &#123;</span><br><span class="line">                            resolve(promiseArrays);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    _resolve(value) &#123;</span><br><span class="line">        // 2</span><br><span class="line">        if (typeof this._resolve !== &quot;function&quot;) &#123;</span><br><span class="line">            this._resolve = () =&gt; &#123;&#125;;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (this.state === MyPromise.PENDING) &#123;</span><br><span class="line">                this.state = MyPromise.FULFILLED;</span><br><span class="line">                this.value = value;</span><br><span class="line">                setTimeout(() =&gt;</span><br><span class="line">                    //setTime必须返回函数</span><br><span class="line">                    this.callbacks.forEach((cb) =&gt; this._handle(cb))</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _reject(reason) &#123;</span><br><span class="line">        if (typeof this._reject !== &quot;function&quot;) &#123;</span><br><span class="line">            this._reject = () =&gt; &#123;&#125;;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (this.state === MyPromise.PENDING) &#123;</span><br><span class="line">                this.state = MyPromise.REJECTED;</span><br><span class="line">                this.error = reason;</span><br><span class="line">                setTimeout(() =&gt; &#123;</span><br><span class="line">                    this.callbacks.forEach((cb) =&gt; this._handle(cb));</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    then(onFulfilled, onRejected) &#123;</span><br><span class="line">        if (typeof onFulfilled !== &quot;function&quot;) &#123;</span><br><span class="line">            onFulfilled = (value) =&gt; value;</span><br><span class="line">        &#125;</span><br><span class="line">        if (typeof onRejected !== &quot;function&quot;) &#123;</span><br><span class="line">            onRejected = (value) =&gt; value;</span><br><span class="line">        &#125;</span><br><span class="line">        const promise = new MyPromise((resolve, reject) =&gt; &#123;</span><br><span class="line">            //链式</span><br><span class="line">            if (this.state === MyPromise.PENDING) &#123;</span><br><span class="line">                //异步任务首先要保存起来,等resolve或者reject调用的时候才能用,传入的时候加&#123;&#125;,不然无法解构</span><br><span class="line">                this.callbacks.push(&#123;</span><br><span class="line">                    onFulfilled: (value) =&gt; &#123;</span><br><span class="line">                        this._parse(</span><br><span class="line">                            promise,</span><br><span class="line">                            onFulfilled(value),</span><br><span class="line">                            resolve,</span><br><span class="line">                            reject</span><br><span class="line">                        );</span><br><span class="line">                    &#125;,</span><br><span class="line">                    onRejected: (reason) =&gt; &#123;</span><br><span class="line">                        this._parse(</span><br><span class="line">                            promise,</span><br><span class="line">                            onRejected(reason),</span><br><span class="line">                            resolve,</span><br><span class="line">                            reject</span><br><span class="line">                        );</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            if (this.state === MyPromise.FULFILLED) &#123;</span><br><span class="line">                setTimeout(() =&gt; &#123;</span><br><span class="line">                    this._parse(</span><br><span class="line">                        promise,</span><br><span class="line">                        onFulfilled(this.value),</span><br><span class="line">                        resolve,</span><br><span class="line">                        reject</span><br><span class="line">                    );</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            if (this.state === MyPromise.REJECTED) &#123;</span><br><span class="line">                setTimeout(() =&gt; &#123;</span><br><span class="line">                    this._parse(</span><br><span class="line">                        promise,</span><br><span class="line">                        onRejected(this.error),</span><br><span class="line">                        resolve,</span><br><span class="line">                        reject</span><br><span class="line">                    );</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        return promise;</span><br><span class="line">    &#125;</span><br><span class="line">    catch(onRejected) &#123;</span><br><span class="line">        return this.then(null, onRejected);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    finally(onFinally) &#123;</span><br><span class="line">        return this.then(onFinally, onFinally);</span><br><span class="line">    &#125;</span><br><span class="line">    _parse(promise, result, resolve, reject) &#123;</span><br><span class="line">        if (promise === result) &#123;</span><br><span class="line">            //步骤7返回约束</span><br><span class="line">            throw new TypeError(&quot;Chaining cycle detected for promise&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //步骤6的公共代码复用</span><br><span class="line">        try &#123;</span><br><span class="line">            if (result instanceof MyPromise) &#123;</span><br><span class="line">                result.then(resolve, reject);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                reject(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            reject(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    _handle(callback) &#123;</span><br><span class="line">        //调用异步中储存的方法</span><br><span class="line">        const &#123; onFulfilled, onRejected &#125; = callback;</span><br><span class="line">        if (this.state === MyPromise.FULFILLED &amp;&amp; onFulfilled) &#123;</span><br><span class="line">            onFulfilled(this.value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (this.state === MyPromise.REJECTED &amp;&amp; onRejected) &#123;</span><br><span class="line">            onRejected(this.error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="缺点与解决方法"><a href="#缺点与解决方法" class="headerlink" title="缺点与解决方法"></a>缺点与解决方法</h3><ol>
<li>Promise 一旦新建就会立即执行，无法中途取消</li>
<li>当处于 pending 状态时，无法得知当前处于哪一个状态，是刚刚开始还是刚刚结束</li>
<li>如果不设置回调函数，Promise 内部的错误就无法反映到外部</li>
</ol>
</div><div class="tags"><a href="/tags/JavaScript%EF%BC%8C%E6%89%8B%E5%86%99%E4%BB%A3%E7%A0%81/"><i class="fa fa-tag"></i>JavaScript，手写代码</a></div><div class="post-nav"><a class="pre" href="/2020/06/14/webpack%E5%B8%B8%E7%94%A8loader%E4%B8%8Eplugin/">webpack常用loader与plugin</a><a class="next" href="/2017/06/10/JavaScript%E7%9A%84%E9%98%B2%E6%8A%96%E4%B8%8E%E8%8A%82%E6%B5%81/">JavaScript的防抖与节流</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://theartlearnjs.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JS%E5%8E%9F%E7%90%86/">JS原理</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Webpack/">Webpack</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%A1%86%E6%9E%B6/">框架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BA%90%E7%A0%81/">源码</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/React/" style="font-size: 15px;">React</a> <a href="/tags/JavaScript%EF%BC%8C%E6%89%8B%E5%86%99%E4%BB%A3%E7%A0%81/" style="font-size: 15px;">JavaScript，手写代码</a> <a href="/tags/Vue/" style="font-size: 15px;">Vue</a> <a href="/tags/Webpack/" style="font-size: 15px;">Webpack</a> <a href="/tags/%E9%85%8D%E7%BD%AE/" style="font-size: 15px;">配置</a> <a href="/tags/%E4%BC%98%E5%8C%96/" style="font-size: 15px;">优化</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/07/19/%E7%BD%91%E7%AB%99%E4%BC%98%E5%8C%96%E7%AC%94%E8%AE%B0/">网站优化笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/05/React-%E5%AE%9E%E7%8E%B0%20(1)/">React-实现 (1)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/Fiber-%E5%9F%BA%E7%A1%80%20(2)/">Fiber 基础 (2)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/13/Fiber-%E5%9F%BA%E7%A1%80%20(1)/">Fiber 基础 (1)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/09/React%E4%B8%8E%08Vue%E5%8C%BA%E5%88%AB/">React与Vue区别</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/27/%E6%89%8B%E5%86%99webpack-loader%E4%B8%8Eplugin/">手写webpack loader与plugin</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/14/webpack%E5%B8%B8%E7%94%A8loader%E4%B8%8Eplugin/">webpack常用loader与plugin</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/24/Promise-%E5%85%A8%E8%A7%A3/">Promise 全解</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/10/JavaScript%E7%9A%84%E9%98%B2%E6%8A%96%E4%B8%8E%E8%8A%82%E6%B5%81/">JavaScript的防抖与节流</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/30/%E6%90%AD%E5%BB%BAhexo%E5%8D%9A%E5%AE%A2/">搭建Hexo博客</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">奋斗的胖锦.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>